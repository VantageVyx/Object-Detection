<!DOCTYPE html>
<html>
<head>
  <title>Person/Cup Detection + Arduino</title>
</head>
<body>
  <h2>Object Detection in the Browser</h2>
  <video id="webcam" width="640" height="480" autoplay playsinline></video>
  <canvas id="canvas" width="640" height="480" style="position: absolute; top: 0; left: 0;"></canvas>
  <br />
  <button onclick="connectToArduino()">ðŸ”Œ Connect to Arduino</button>

  <!-- Load TensorFlow.js and COCO-SSD -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.20.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>

  <script>
    let model, ctx, video, canvas, writer = null;

    async function connectToArduino() {
      try {
        const port = await navigator.serial.requestPort();
        await port.open({ baudRate: 9600 });
        writer = port.writable.getWriter();
        alert("âœ… Arduino connected!");
      } catch (err) {
        alert("âŒ Error connecting to Arduino: " + err);
      }
    }

    async function start() {
      model = await cocoSsd.load();
      video = document.getElementById('webcam');
      canvas = document.getElementById('canvas');
      ctx = canvas.getContext('2d');

      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;

        video.onloadedmetadata = () => {
          detectFrame();
        };
      } catch (err) {
        alert("âŒ Webcam access failed: " + err.message);
      }
    }

    async function detectFrame() {
      const predictions = await model.detect(video);
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      let personCount = 0;
      let foundCup = false;

      predictions.forEach(pred => {
        const [x, y, width, height] = pred.bbox;
        const label = `${pred.class} ${Math.round(pred.score * 100)}%`;

        ctx.strokeStyle = "lime";
        ctx.lineWidth = 2;
        ctx.strokeRect(x, y, width, height);

        ctx.font = "16px sans-serif";
        ctx.fillStyle = "lime";
        ctx.fillText(label, x, y - 5);

        if (pred.class === "person" && pred.score > 0.25) {
          personCount++;
        }

        if (pred.class === "cup" && pred.score > 0.25) {
          foundCup = true;
        }
      });

      if (writer) {
        if (personCount >= 2) {
          await writer.write(new TextEncoder().encode('3')); //2+ people
        } else if (personCount === 1) {
          await writer.write(new TextEncoder().encode('1')); //1 person
        } else if (foundCup) {
          await writer.write(new TextEncoder().encode('2')); //cup
        } else {
          await writer.write(new TextEncoder().encode('0')); //nothing
        }
      }

      requestAnimationFrame(detectFrame);
    }

    start();
  </script>
</body>
</html>
